# 🏗️ BUY商城系統架構說明

## 系統整體架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                         使用者端                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────┐        ┌────────────────────┐    │
│  │   Vue 3 前台 (SPA)    │        │  MVC 後台管理系統   │    │
│  │  - 會員購物介面       │        │  - Admin 管理後台   │    │
│  │  - 購物車/結帳       │        │  - Vendor 廠商後台  │    │
│  │  - 訂單查詢          │        │  - 報表/統計       │    │
│  └──────────┬───────────┘        └────────┬───────────┘    │
│             │                              │                 │
│             ↓ HTTP/HTTPS                  ↓ HTTP/HTTPS      │
└─────────────────────────────────────────────────────────────┘
              │                              │
┌─────────────┴──────────────────────────────┴─────────────────┐
│                         後端服務層                             │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │           ASP.NET Core Web API (RESTful)               │  │
│  │                                                        │  │
│  │  職責：                                                │  │
│  │  1. 提供前台所需的所有資料 API                         │  │
│  │  2. 處理業務邏輯（訂單、付款、物流等）                  │  │
│  │  3. 資料驗證和安全性控管                              │  │
│  │  4. 與第三方服務整合（金流、物流、簡訊等）              │  │
│  │  5. 檔案上傳/下載服務                                 │  │
│  │  6. JWT Token 認證授權                                │  │
│  │                                                        │  │
│  │  架構：三層式架構                                      │  │
│  │  - Controllers (API 端點)                             │  │
│  │  - Services (業務邏輯層)                              │  │
│  │  - Repositories (資料存取層)                          │  │
│  └────────────────────────────────────────────────────────┘  │
│                              │                                │
│                              ↓                                │
│  ┌────────────────────────────────────────────────────────┐  │
│  │           ASP.NET Core MVC (後台管理系統)              │  │
│  │                                                        │  │
│  │  職責：                                                │  │
│  │  1. 內部管理介面（Admin/Vendor）                       │  │
│  │  2. 權限管理（Area 分離）                              │  │
│  │  3. 報表生成與匯出                                    │  │
│  │  4. 系統設定管理                                      │  │
│  │  5. 直接操作資料庫進行維護                            │  │
│  │                                                        │  │
│  │  特點：                                                │  │
│  │  - Server-Side Rendering (SSR)                        │  │
│  │  - Razor Views                                        │  │
│  │  - Session-based 認證                                 │  │
│  └────────────────────────────────────────────────────────┘  │
│                              │                                │
└──────────────────────────────┴────────────────────────────────┘
                               │
┌──────────────────────────────┴────────────────────────────────┐
│                         資料層                                 │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │              SQL Server (FUEN42_G2_DB)                   │ │
│  │                                                          │ │
│  │  主要資料表：                                            │ │
│  │  - Members (會員)          - MasterOrders (主訂單)       │ │
│  │  - Vendors (廠商)          - Orders (子訂單)            │ │
│  │  - Products (商品)         - OrderItems (訂單項目)      │ │
│  │  - Categories (分類)       - Payments (付款記錄)        │ │
│  │  - Coupons (優惠券)       - Shipments (物流記錄)       │ │
│  │  - Banners (廣告)         - Returns (退貨記錄)         │ │
│  │  - SupportTickets (客服)  - Reviews (評價)             │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 一、Web API 的職責（不只是單純撈資料）

### 1. 資料存取層
```csharp
// Repository 層 - 負責資料庫操作
public class OrderRepository : IOrderRepository
{
    // 基本 CRUD 操作
    public async Task<Order> GetByIdAsync(int id)
    {
        // 從資料庫撈取訂單
        return await _context.Orders
            .Include(o => o.OrderItems)
            .Include(o => o.Payment)
            .FirstOrDefaultAsync(o => o.Id == id);
    }
}
```

### 2. 業務邏輯層
```csharp
// Service 層 - 複雜的業務邏輯處理
public class OrderService : IOrderService
{
    public async Task<CreateOrderResponse> CreateOrderAsync(CreateOrderRequest request)
    {
        // 1. 驗證商品庫存
        await ValidateInventory(request.Items);
        
        // 2. 計算價格（包含優惠券、運費等）
        var pricing = await CalculatePricing(request);
        
        // 3. 創建訂單（可能涉及多個資料表）
        var masterOrder = await CreateMasterOrder(request, pricing);
        var subOrders = await CreateSubOrders(masterOrder, request.Items);
        
        // 4. 扣減庫存
        await UpdateInventory(request.Items);
        
        // 5. 發送通知（Email、簡訊）
        await NotifyOrderCreated(masterOrder);
        
        // 6. 整合第三方金流
        var paymentUrl = await ProcessPayment(masterOrder, request.PaymentMethod);
        
        return new CreateOrderResponse
        {
            OrderId = masterOrder.Id,
            PaymentUrl = paymentUrl
        };
    }
}
```

### 3. API Controller 層
```csharp
[ApiController]
[Route("api/[controller]")]
public class OrdersController : ControllerBase
{
    private readonly IOrderService _orderService;
    
    [HttpPost]
    [Authorize] // JWT Token 驗證
    public async Task<IActionResult> CreateOrder([FromBody] CreateOrderRequest request)
    {
        // 1. 模型驗證
        if (!ModelState.IsValid)
            return BadRequest(ModelState);
        
        // 2. 獲取當前用戶
        var userId = User.FindFirst("UserId")?.Value;
        request.UserId = int.Parse(userId);
        
        // 3. 呼叫業務邏輯
        var response = await _orderService.CreateOrderAsync(request);
        
        // 4. 返回結果
        return Ok(new ApiResponse<CreateOrderResponse>
        {
            Success = true,
            Data = response,
            Message = "訂單創建成功"
        });
    }
}
```

## 二、前台 Vue 如何呼叫 Web API

### 1. API 模組定義
```typescript
// src/api/modules/order.ts
import http from '../http'

export const orderApi = {
  // 創建訂單 - 呼叫 POST /api/orders
  createOrder: async (data: CreateOrderRequest) => {
    const response = await http.post<CreateOrderResponse>('/orders', data)
    return response.data
  },
  
  // 查詢訂單 - 呼叫 GET /api/orders/{id}
  getOrder: async (id: number) => {
    const response = await http.get<OrderInfo>(`/orders/${id}`)
    return response.data
  },
  
  // 處理付款回調 - 呼叫 POST /api/payments/callback
  handlePaymentCallback: async (data: PaymentCallbackData) => {
    const response = await http.post('/payments/callback', data)
    return response.data
  }
}
```

### 2. 在 Vue 組件中使用
```vue
<script setup lang="ts">
import { orderApi } from '@/api/modules/order'
import { useCartStore } from '@/stores/modules/cart'

const cartStore = useCartStore()

const submitOrder = async () => {
  try {
    // 準備訂單資料
    const orderData = {
      items: cartStore.items.map(item => ({
        productId: item.productId,
        quantity: item.quantity,
        price: item.price
      })),
      shippingAddress: formData.address,
      paymentMethodId: selectedPaymentMethod.value
    }
    
    // 呼叫 API
    const result = await orderApi.createOrder(orderData)
    
    // 處理結果
    if (result.paymentUrl) {
      // 導向第三方金流
      window.location.href = result.paymentUrl
    } else {
      // 導向訂單完成頁
      router.push(`/orders/${result.orderId}`)
    }
  } catch (error) {
    console.error('訂單創建失敗:', error)
  }
}
</script>
```

## 三、MVC 後台與前台的關係

### 1. MVC 後台的角色
```csharp
// Areas/Admin/Controllers/OrderController.cs
[Area("Admin")]
[Authorize(Roles = "Admin,Manager")]
public class OrderController : Controller
{
    // 後台訂單管理頁面
    public IActionResult Index()
    {
        // 直接從資料庫撈取所有訂單
        var orders = _orderService.GetAllOrders();
        
        // 返回 Razor View (SSR)
        return View(orders);
    }
    
    // 審核訂單
    [HttpPost]
    public IActionResult Approve(int orderId)
    {
        _orderService.ApproveOrder(orderId);
        return RedirectToAction("Index");
    }
    
    // 匯出報表
    public IActionResult ExportExcel(DateTime startDate, DateTime endDate)
    {
        var data = _reportService.GenerateOrderReport(startDate, endDate);
        var excel = _excelService.CreateExcel(data);
        return File(excel, "application/vnd.ms-excel", "orders.xlsx");
    }
}
```

### 2. MVC 後台不直接服務前台用戶
```csharp
// MVC 後台主要功能：
// 1. 內部管理人員使用
// 2. 廠商管理自己的商品和訂單
// 3. 系統維護和設定
// 4. 報表和統計
// 5. 批次作業處理

// Areas/Vendor/Controllers/ProductController.cs
[Area("Vendor")]
[Authorize(Roles = "Vendor")]
public class ProductController : Controller
{
    // 廠商管理自己的商品
    public IActionResult MyProducts()
    {
        var vendorId = GetCurrentVendorId();
        var products = _productService.GetVendorProducts(vendorId);
        return View(products); // Razor View
    }
}
```

## 四、資料流動示例

### 場景：用戶下單購買商品

```
1. 用戶在 Vue 前台選擇商品加入購物車
   └─> localStorage 暫存購物車資料

2. 用戶進入結帳頁面，填寫收件資訊
   └─> Vue 組件驗證表單資料

3. 用戶確認訂單，點擊送出
   └─> Vue 呼叫 orderApi.createOrder()
       └─> 發送 POST 請求到 Web API: /api/orders

4. Web API 接收請求
   ├─> 驗證 JWT Token
   ├─> 驗證請求資料
   ├─> 呼叫 OrderService.CreateOrderAsync()
   │   ├─> 檢查商品庫存
   │   ├─> 計算金額
   │   ├─> 寫入資料庫（Orders, OrderItems, Payments 等表）
   │   ├─> 扣減庫存
   │   ├─> 整合第三方金流 API
   │   └─> 發送通知
   └─> 返回結果給前台

5. Vue 前台收到回應
   ├─> 如有金流 URL，導向第三方支付
   └─> 否則顯示訂單完成頁面

6. 金流回調
   └─> 第三方金流呼叫 Web API: /api/payments/callback
       ├─> 驗證回調資料
       ├─> 更新訂單付款狀態
       └─> 通知前台付款結果

7. 後台管理
   └─> Admin 在 MVC 後台查看訂單
       ├─> 審核訂單
       ├─> 安排出貨
       └─> 處理客訴
```

## 五、實際整合範例

### 1. 訂單狀態同步
```typescript
// Vue 前台 - 定期查詢訂單狀態
const checkOrderStatus = async (orderId: number) => {
  const order = await orderApi.getOrder(orderId)
  
  // 根據狀態顯示不同內容
  switch(order.status) {
    case OrderStatus.Pending:
      showMessage('訂單處理中...')
      break
    case OrderStatus.Shipped:
      showMessage('商品已出貨！')
      showTrackingInfo(order.trackingNumber)
      break
    case OrderStatus.Delivered:
      showReviewButton()
      break
  }
}

// 每 30 秒查詢一次
setInterval(() => checkOrderStatus(currentOrderId), 30000)
```

### 2. 庫存即時檢查
```typescript
// Web API 提供即時庫存檢查
[HttpPost("check-inventory")]
public async Task<IActionResult> CheckInventory([FromBody] List<CartItem> items)
{
    var results = new List<InventoryCheckResult>();
    
    foreach(var item in items)
    {
        var product = await _productService.GetByIdAsync(item.ProductId);
        results.Add(new InventoryCheckResult
        {
            ProductId = item.ProductId,
            RequestedQty = item.Quantity,
            AvailableQty = product.StockQuantity,
            IsAvailable = product.StockQuantity >= item.Quantity
        });
    }
    
    return Ok(results);
}
```

### 3. 權限區分
```typescript
// Vue 前台 - 一般會員權限
const userOrders = await orderApi.getMyOrders() // 只能看自己的訂單

// MVC 後台 - 管理員權限
public IActionResult AllOrders()
{
    var orders = _orderService.GetAllOrders(); // 可以看所有訂單
    return View(orders);
}
```

## 六、重要觀念釐清

### Web API 不只是 CRUD
1. **業務邏輯處理**：計算、驗證、流程控制
2. **第三方整合**：金流、物流、簡訊、Email
3. **資料聚合**：從多個表組合資料
4. **非同步處理**：背景作業、排程任務
5. **快取管理**：Redis、Memory Cache
6. **安全控管**：認證、授權、資料加密

### MVC 後台與前台的區別
| 特性 | Vue 前台 | MVC 後台 |
|-----|---------|----------|
| 使用者 | 一般消費者、會員 | 管理員、廠商 |
| 渲染方式 | CSR (Client-Side) | SSR (Server-Side) |
| 認證方式 | JWT Token | Session/Cookie |
| 功能範圍 | 購物、查詢訂單 | 管理、維護、報表 |
| 資料來源 | 透過 Web API | 直接存取資料庫 |
| 更新頻率 | 即時、動態 | 定期、批次 |

### 為什麼要這樣設計？
1. **關注點分離**：前後台職責明確
2. **擴展性**：API 可服務多個前端（Web、App）
3. **維護性**：前後端可獨立開發部署
4. **安全性**：API 層統一處理安全驗證
5. **效能**：前端 SPA 體驗好，後台 SSR 適合複雜表單

## 七、C組（訂單/金流/物流）的整合重點

### 1. 與 Web API 的整合
```typescript
// 需要實作的 API 端點
- POST   /api/orders                // 創建訂單
- GET    /api/orders                // 查詢訂單列表
- GET    /api/orders/{id}           // 查詢訂單詳情
- PATCH  /api/orders/{id}/cancel    // 取消訂單
- POST   /api/payments/process      // 處理付款
- POST   /api/payments/callback     // 金流回調
- GET    /api/shipments/track       // 物流追蹤
- POST   /api/returns               // 申請退貨
- POST   /api/refunds               // 申請退款
```

### 2. 與 MVC 後台的協作
```csharp
// MVC 後台會提供這些管理功能
- 訂單審核和管理
- 退貨退款審核
- 物流單號錄入
- 訂單報表匯出
- 異常訂單處理
```

### 3. 資料流轉關鍵點
- 訂單創建時的庫存檢查（需與 B 組協調）
- 優惠券使用（需與 D 組協調）
- 會員資訊驗證（需與 A 組協調）
- 訂單完成後的評價（需與 E 組協調）

---

**總結**：Web API 是業務邏輯的核心，不只是簡單的資料存取。MVC 後台是內部管理工具，不直接服務前台用戶。兩者透過共用資料庫和業務邏輯層來保持資料一致性。